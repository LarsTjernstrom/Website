<link rel="import" href="/sys/polymer/polymer.html">
<link rel="import" href="/sys/paper-collapse-item/paper-collapse-item.html" />

<template>
    <template is="dom-bind">
        <fieldset>
            <legend>
                <span class="pull-right">
                    <button type="button" class="btn btn-xs btn-success" value="{{model.SaveChangesTrigger$::click}}"
                            onmousedown="++this.value;" disabled="{{!model.Trn.IsDirty}}" title="Save all changes">
                        Save
                    </button>
                    <button type="button" class="btn btn-xs btn-default" value="{{model.CancelChangesTrigger$::click}}"
                            onmousedown="++this.value;" disabled="{{!model.Trn.IsDirty}}" title="Cancel all changes">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-xs btn-default" value="{{model.CreateTrigger$::click}}"
                            onmousedown="++this.value;" title="Create catching rule">
                        Create
                    </button>
                </span>
                Catching rules
            </legend>
            <template is="dom-repeat" items="{{model.CatchingRules}}" as="catchingRule">
                <paper-collapse-item>
                    <div slot="header" class="website-catching-rules-table-header">
                        <template is="dom-if" if="{{catchingRule.Url$}}">
                            <div class="website-catching-rules-table-header__uri-label">URI: {{catchingRule.Url$}}</div>
                        </template>
                        <template is="dom-if" if="{{!catchingRule.Url$}}">
                            <div class="website-catching-rules-table-header__uri-label">URI: Any URI</div>
                        </template>
                        <div class="website-catching-rules-table-header__headers">{{catchingRule.HeadersString}}</div>
                        <template is="dom-if" if="{{!catchingRule.IsFinal$}}">
                            <label class="website-catching-rules-table-header__nestable">Nestable</label>
                        </template>
                    </div>
                    <div class="website-catching-rules-catch-uri-section">
                        <label for="websiteCatchingRuleUri">Catch URI: </label>
                        <input type="text" id="websiteCatchingRuleUri" value="{{catchingRule.Url$::change}}" class="website-catching-rules-table-header-uri__uri" on-tap="tappedOnInput"/>
                    </div>
                    <div>
                        <label for="websiteCatchingRuleNestable">Nestable</label>
                        <input type="checkbox" id="websiteCatchingRuleNestable" checked="{{!catchingRule.IsFinal$::change}}" on-tap="tappedOnInput"/>
                        <div class="website-catching-rules-final-note">
                            If a rule is nestable, other surfaces will be matched against this surface's View URI. It results in this surface being pinned in the default blending point of another surface that catches it.<br/>
                            <b>Note:</b> currently only rules with specified URI are nestable.
                        </div>
                    </div>
                    <div>
                        <template is="dom-if" if="{{catchingRule.Headers.length}}">
                            <table class="website-table table">
                                <thead>
                                <tr>
                                    <th>Header key</th>
                                    <th>Header value</th>
                                    <th class="website-table__cell-actions"></th>
                                </tr>
                                </thead>
                                <tbody>
                                <template is="dom-repeat" items="{{catchingRule.Headers}}" as="catchHeader">
                                    <tr>
                                        <td>
                                            <input type="text" value="{{catchHeader.Name$::change}}"/>
                                        </td>
                                        <td>
                                            <input type="text" value="{{catchHeader.Value$::change}}"/>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-xs btn-danger" value="{{catchHeader.DeleteTrigger$::click}}" onmousedown="++this.value;" title="Remove catch header">
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                                </tbody>
                            </table>
                        </template>
                    </div>
                    <div class="website-catching-rules-buttons">
                        <div class="website-catching-rules-buttons__add">
                            <button type="button" class="btn btn-xs btn-success" value="{{catchingRule.AddHeaderTrigger$::click}}" onmousedown="++this.value;" title="Add new catch header">
                                New header rule
                            </button>
                        </div>
                        <div class="website-catching-rules-buttons__delete">
                            <button type="button" class="btn btn-xs btn-danger" value="{{catchingRule.DeleteTrigger$::click}}" onmousedown="++this.value;" title="Delete this catching rule">
                                Delete catching rule
                            </button>
                        </div>
                    </div>
                </paper-collapse-item>
            </template>
        </fieldset>
    </template>
    <script>
        (function () {
            var template = document.currentScript.previousElementSibling;

            template.tappedOnInput = function (event) {
                event.stopPropagation();
            }

            setTimeout(function () {
                var selects = template.parentNode.querySelectorAll("select");

                for (var i = 0; i < selects.length; i++) {
                    var s = selects[i];

                    s.value = s.key;
                }
            });
        })();
    </script>
</template>
